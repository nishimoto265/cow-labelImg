# Undo/Redo機能 要件定義書

## 概要
labelImgアプリケーションに統一的なUndo/Redo機能を実装する。全ての操作を一貫した方法で管理し、ユーザーが直感的に操作を取り消し・やり直しできるようにする。

## 機能要件

### 1. 基本機能
- **Undo (Ctrl+Z)**: 直前の操作を取り消す
- **Redo (Ctrl+Y)**: 取り消した操作をやり直す  
- **履歴管理**: 最大50操作まで履歴を保持

### 2. 対象操作
以下の全ての操作をUndo/Redo対象とする：

#### 2.1 単一フレーム操作
- **BB作成**: 新しいBounding Boxの作成
- **BB削除**: 選択したBounding Boxの削除
- **BB編集**: Bounding Boxの位置・サイズ変更
- **ラベル変更**: Bounding Boxのラベル変更
- **BB複製**: 同一フレーム内でのBB複製

#### 2.2 複数フレーム操作
- **BB複製（複数フレーム）**: 後続フレームへのBB複製
- **連続トラッキング**: 複数フレームにわたるID付与
- **一括削除**: 複数フレームからの同一ID削除
- **一括ラベル変更**: 複数フレームでの同一IDラベル変更

### 3. 状態管理
- **状態の定義**: 各フレームのBounding Box情報（位置、ラベル、ID等）
- **状態の保存タイミング**: 操作実行直後
- **フレーム切り替え時**: 各フレームで独立した履歴を管理

## 技術設計

### 1. アーキテクチャ
**Memento Pattern**を採用し、シンプルで拡張性のある実装とする。

```python
class UndoManager:
    def __init__(self, max_history=50):
        self.history = []        # 履歴スタック
        self.current_index = -1  # 現在の位置
        
    def save_state(self, state):
        # 現在の状態を保存
        
    def undo(self):
        # 一つ前の状態に戻す
        
    def redo(self):
        # 一つ後の状態に進む
```

### 2. 状態データ構造
```python
{
    'frame_index': int,           # フレーム番号
    'file_path': str,             # ファイルパス
    'shapes': [                   # BBリスト
        {
            'points': [(x,y), ...],  # 座標
            'label': str,            # ラベル
            'track_id': int,         # トラッキングID
            'difficult': bool,       # 難易度フラグ
            'attributes': {}         # その他属性
        }
    ],
    'operation_type': str         # 操作タイプ（デバッグ用）
}
```

### 3. 実装方針
1. **統一インターフェース**: 全ての操作を同じ方法で処理
2. **Deep Copy**: 状態保存時は完全なコピーを作成
3. **メモリ管理**: 履歴サイズを制限してメモリ使用量を抑制
4. **パフォーマンス**: 大量のBBがある場合も高速に動作

## 実装計画

### Phase 1: 基本実装
1. UndoManagerクラスの作成
2. 単一フレーム操作への適用
3. キーボードショートカットの実装

### Phase 2: 複数フレーム対応
1. 複数フレーム操作の状態管理
2. フレーム切り替え時の履歴管理
3. 複雑な操作のグループ化

### Phase 3: 最適化とテスト
1. パフォーマンス最適化
2. エッジケースの処理
3. ユーザビリティテスト

## 注意事項
- ファイル保存時は履歴をクリアしない
- フレーム切り替え時は各フレームの履歴を保持
- 自動保存との競合を避ける実装
- エラー時は安全側に倒す（データ損失を防ぐ）

## 成功基準
- 全ての操作がUndo/Redo可能
- 操作が直感的で分かりやすい
- パフォーマンスが良好（遅延なし）
- バグやデータ損失がない