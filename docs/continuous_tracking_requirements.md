# 連続追跡機能要件定義

## 概要
labelImgに追跡アルゴリズムを使用して、連続するフレーム間でバウンディングボックス（BB）に同一のラベルを自動的に付与する機能を追加する。

## 機能詳細

### 基本動作
1. ユーザーがtフレームでバウンディングボックスにラベルを付与
2. 次のフレーム（t+1）に移動した際、追跡アルゴリズムが前フレームのBBを追跡
3. 追跡に成功したBBに対して、自動的に同じラベルを付与

### 追跡アルゴリズム
- **手法**: IOU（Intersection over Union）とハンガリアンアルゴリズムを組み合わせた追跡
- **IOUしきい値**: 0.4
  - IOU >= 0.4の場合、追跡成功とみなす
  - IOU < 0.4の場合、追跡失敗（連続ID付与は途切れ、新規BBとして扱う）

### アルゴリズム詳細
1. 前フレームの全BBと現フレームの全BB間でIOUを計算
2. IOUマトリックスを作成
3. ハンガリアンアルゴリズムを使用して最適なマッチングを決定
4. しきい値（0.4）を満たすマッチングのみを採用
5. 追跡失敗したBBの連続ID付与は終了（以降は新規BBとして扱う）

## GUI設計

### 配置
- 既存の「指定されたラベルを使う」チェックボックスの下部にスペースを確保
- 新規チェックボックス「連続ID付けモード」を追加

### 動作仕様
- チェックボックスON時：連続追跡機能が有効
- チェックボックスOFF時：従来の手動ラベリング動作

## 実装上の考慮事項

### データ管理
- フレーム間のBB情報を保持する仕組みが必要
- 各BBにユニークIDを付与し、フレーム間で追跡

### パフォーマンス
- リアルタイムで追跡計算を行うため、効率的な実装が必要
- 大量のBBが存在する場合でも、レスポンシブな動作を維持

### ユーザビリティ
- 追跡結果の可視化（追跡成功/失敗の表示）
- 手動での追跡結果の修正機能

## プロジェクト構造と実装場所

### 既存ファイル構造
```
cow-labelImg/
├── labelImg.py          # メインアプリケーション (MainWindowクラス)
├── libs/
│   ├── canvas.py        # BB描画と管理 (self.shapesリスト)
│   ├── shape.py         # BB情報クラス (ラベル、座標等)
│   ├── utils.py         # ユーティリティ関数
│   └── ...
└── resources/
    └── icons/           # GUIアイコン
```

### 実装場所と変更内容

#### 1. 新規ファイル作成
- `libs/tracker.py` - 追跡アルゴリズムの実装
  - IOUベースの追跡クラス
  - ハンガリアンアルゴリズムによるマッチング
  - フレーム間のBB対応付け管理

#### 2. 既存ファイルの変更

##### labelImg.py (MainWindowクラス)
- **追加する属性**:
  - `self.continuous_tracking_mode` - 追跡モードのON/OFF状態
  - `self.tracker` - 追跡オブジェクト
  - `self.prev_frame_shapes` - 前フレームのBB情報

- **変更するメソッド**:
  - `__init__`: 追跡関連の初期化、GUIチェックボックスの追加
  - `open_next_image`: フレーム遷移時の追跡処理呼び出し (1450行付近)
  - `open_prev_image`: 前フレーム遷移時の処理
  - `reset_state`: 追跡情報のリセット (644行付近)

- **追加するメソッド**:
  - `toggle_continuous_tracking`: 追跡モードの切り替え
  - `apply_tracking`: 追跡結果の適用
  - `store_current_shapes`: 現在のBB情報の保存

##### libs/shape.py
- **追加する属性**:
  - `self.track_id` - 追跡用の一意ID
  - `self.is_tracked` - 追跡されたBBかどうかのフラグ

##### libs/canvas.py
- **変更内容**:
  - 追跡されたBBの視覚的な区別（色や線のスタイル）

### GUI配置詳細
- **場所**: 「指定されたラベルを使う」チェックボックスの下 (130行付近)
- **実装**: QCheckBoxウィジェット「連続ID付けモード」
- **シグナル**: `stateChanged`でトグル処理

## 技術要件

### 必要なライブラリ
- `scipy`（ハンガリアンアルゴリズム実装用）
- `numpy`（IOU計算用）

### 既存コードへの影響
- 最小限の変更で既存機能を維持
- 後方互換性を確保

## テスト項目
1. IOU計算の正確性
2. ハンガリアンアルゴリズムによるマッチングの妥当性
3. しきい値（0.4）の効果検証
4. GUI操作の動作確認
5. パフォーマンステスト（多数のBBでの動作速度）